(()=>{"use strict";window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},debounce:e=>{let t=null;return(...r)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...r)}),500)}}},(()=>{const e="https://21.javascript.pages.academy/kekstagram",t=(e,t)=>{const r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(()=>{switch(r.status){case 200:e(r.response);break;case 400:t("Неверный запрос");break;case 401:t("Пользователь не авторизован");break;case 404:t("Ничего не найдено");break;default:t(`Статус ответа: ${r.status} ${r.statusText}`)}})),r.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.timeout=1e4,r};window.backend={load:(r,n)=>{const o=t(r,n);o.open("GET",e+"/data"),o.send()},save:(r,n,o)=>{const s=t(n,o);s.open("POST",e),s.send(r)}}})(),window.filter={getRandomPictureObjects:e=>{let t=[],r=e.slice();for(let e=0;e<10;e++){let e=(0,n=r.length-1,Math.round(Math.random()*(n-0))+0);t.push(r[e]),r.splice(e,1)}var n;return t},getDiscussedPictureObjects:e=>e.slice().sort(((e,t)=>t.comments.length-e.comments.length))},(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content,r=document.querySelector(".img-filters"),n=r.querySelector(".img-filters__form"),o=n.querySelectorAll(".img-filters__button"),s=n.querySelector("#filter-default"),c=n.querySelector("#filter-random"),l=n.querySelector("#filter-discussed"),i=r=>{(r=>{const n=e.querySelectorAll(".picture");Array.from(n).forEach((t=>e.removeChild(t)));const o=document.createDocumentFragment();r.forEach((e=>o.appendChild((e=>{const r=t.cloneNode(!0);return r.querySelector(".picture__img").src=e.url,r.querySelector(".picture__likes").textContent=e.likes,r.querySelector(".picture__comments").textContent=e.comments.length,r})(e)))),e.appendChild(o)})(r);const n=e.querySelectorAll(".picture");Array.from(n).forEach(((e,t)=>window.getBigPicture(e,r[t])))},a=window.util.debounce((e=>{let t;switch(e.target){case s:t=u;break;case c:t=window.filter.getRandomPictureObjects(u);break;case l:t=window.filter.getDiscussedPictureObjects(u)}i(t)})),d=e=>{var t;a(e),t=e.target,Array.from(o).forEach((e=>e.classList.remove("img-filters__button--active"))),t.classList.add("img-filters__button--active")};let u=[];window.backend.load((e=>{u=e,r.classList.remove("img-filters--inactive"),i(u),n.addEventListener("click",d)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red; position: absolute; left: 0; right: 0; font-size: 30px;",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}))})(),(()=>{const e=document.querySelector("body"),t=e.querySelector(".big-picture"),r=t.querySelector(".big-picture__cancel"),n=t.querySelector(".big-picture__img > img"),o=t.querySelector(".social__comments"),s=t.querySelector(".likes-count"),c=t.querySelector(".social__caption"),l=t.querySelector(".social__comment-count"),i=l.querySelector(".comments-count"),a=o.children,d=o.querySelector(".social__comment"),u=t.querySelector(".comments-loader");let m;const v=()=>{const e=m;m+=5,m>=a.length&&(m=a.length,u.classList.add("hidden")),Array.from(a).filter(((t,r)=>{r>=e&&r<m&&t.classList.remove("visually-hidden")})),l.textContent=`${m} из ${a.length} комментариев`};window.getBigPicture=(y,f)=>{y.addEventListener("click",(()=>{(y=>{t.classList.remove("hidden"),e.classList.add("modal-open"),r.addEventListener("click",p),document.addEventListener("keydown",g),n.src=y.url,s.textContent=y.likes,i.textContent=y.comments.length,c.textContent=y.description,Array.from(a).forEach((e=>e.remove()));const f=document.createDocumentFragment();y.comments.forEach((e=>f.appendChild((e=>{const t=d.cloneNode(!0);return t.querySelector("img").src=e.avatar,t.querySelector("img").alt=e.name,t.querySelector(".social__text").textContent=e.message,t})(e)))),o.appendChild(f),a.length<=5?(u.classList.add("hidden"),l.textContent=`${a.length} из ${a.length} комментариев`):(u.classList.remove("hidden"),l.textContent=`5 из ${a.length} комментариев`,Array.from(a).filter(((e,t)=>{t>=5&&e.classList.add("visually-hidden")})),m=5,u.addEventListener("click",v))})(f)}))};const y=()=>{t.classList.add("hidden"),e.classList.remove("modal-open"),r.removeEventListener("click",p),document.removeEventListener("keydown",g),u.removeEventListener("click",v)},g=e=>{window.util.isEscEvent(e,y)},p=()=>{y()}})(),(()=>{const e=document.querySelector(".text__hashtags"),t=document.querySelector(".text__description"),r="border: 4px solid red;",n="border: none;";window.validation={getHastags:()=>{const t=e.value.toLowerCase().split(" ").filter((e=>""!==e));t.length>5?(e.setCustomValidity("Максимально допустимо 5 хэштегов"),e.style=r):t.every((e=>/^#[А-Яа-яЁёA-Za-z\d]{1,19}$/.test(e)))?(()=>{let e,r,n=t.slice();for(;n.length;)e=n.shift(),n.indexOf(e)>=0&&(r=!0);return r})()?(e.setCustomValidity("Недопустимы повторы хэштегов"),e.style=r):(e.setCustomValidity(""),e.style=n):(e.setCustomValidity("Недопустимый формат хэштега"),e.style=r),e.reportValidity()},getComment:()=>{const e=t.value.length;e>140?(t.setCustomValidity(`Удалите лишние ${e-140} симв.`),t.style=r):(t.setCustomValidity(""),t.style=n),t.reportValidity()}}})(),(()=>{const e=document.querySelector(".img-upload__effect-level"),t=e.querySelector(".effect-level__depth"),r=e.querySelector(".effect-level__pin"),n=e.querySelector(".effect-level__value");r.addEventListener("mousedown",(o=>{const s=e.querySelector(".effect-level__line").offsetWidth;let c=o.clientX;const l=e=>{const o=c-e.clientX;c=e.clientX;let l=r.offsetLeft-o;l<0?l=0:l>s&&(l=s),r.style.left=l+"px",t.style.width=l+"px",n.value=Math.round(100*l/s)},i=()=>{document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",i)}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t={none:{min:0,max:0,getStyle:()=>""},chrome:{min:0,max:1,getStyle:e=>`grayscale(${e})`},sepia:{min:0,max:1,getStyle:e=>`sepia(${e})`},marvin:{min:0,max:100,getStyle:e=>`invert(${e}%)`},phobos:{min:0,max:3,getStyle:e=>`blur(${e}px)`},heat:{min:1,max:3,getStyle:e=>`brightness(${e})`}},r={min:25,max:100,step:25,current:100,getStyle:e=>`transform: scale(${e/100})`},n=document.querySelector(".img-upload__start"),o=n.querySelector(".img-upload__input"),s=document.querySelector(".img-upload__form"),c=s.querySelector(".img-upload__overlay"),l=c.querySelector(".img-upload__preview > img"),i=c.querySelector(".img-upload__cancel"),a=c.querySelector(".text__hashtags"),d=c.querySelector(".text__description"),u=c.querySelector(".img-upload__effects"),m=u.querySelectorAll(".effects__preview"),v=u.querySelector("#effect-none"),y=c.querySelector(".scale__control--smaller"),g=c.querySelector(".scale__control--bigger"),p=c.querySelector(".scale__control--value"),f=document.querySelector(".img-upload__effect-level"),_=f.querySelector(".effect-level__pin"),S=f.querySelector(".effect-level__value"),w=f.querySelector(".effect-level__depth"),E=e=>{p.value=e+"%",l.style=r.getStyle(e),e===r.max&&(g.disabled=!0),e===r.min&&(y.disabled=!0)},L=()=>{r.current=r.current-r.step,E(r.current),r.current<r.max&&(g.disabled=!1)},h=()=>{r.current=r.current+r.step,E(r.current),r.current>r.min&&(y.disabled=!1)};let q,b;const k=e=>{var r;return r=e.target.value,q&&l.classList.remove(q),l.classList.add("effects__preview--"+r),q="effects__preview--"+r,b=e.target.value,_.style.left="100%",w.style.width="100%",l.classList.contains("effects__preview--none")?(f.style.display="none",S.value=""):(f.style.display="block",S.value=100),l.style.filter=t[b].getStyle(t[b].max),_.addEventListener("mouseup",x),b},x=()=>{(e=>{const r=((e,r)=>{const n=t[e];return n.min+(n.max-n.min)/100*r})(e,S.value);l.style.filter=t[e].getStyle(r)})(b)};n.addEventListener("change",(()=>{c.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),i.addEventListener("click",C),document.addEventListener("keydown",$),u.addEventListener("input",k),a.addEventListener("input",window.validation.getHastags),d.addEventListener("input",window.validation.getComment),(t=>{const r=t.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{l.src=e.result,Array.from(m).forEach((t=>{t.style=`background-image: url(${e.result})`}))})),e.readAsDataURL(t)}})(o.files[0]),E(r.current),f.style.display="none",y.addEventListener("click",L),g.addEventListener("click",h),s.addEventListener("submit",window.submitHandler)}));const C=()=>{c.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),o.value="",l.className="",l.style.filter="",a.value="",d.value="",v.checked="true",S.value="",r.current=r.max,y.disabled=!1,l.src="#",i.removeEventListener("click",C),document.removeEventListener("keydown",$),u.removeEventListener("input",k),_.removeEventListener("mouseup",x),a.removeEventListener("input",window.validation.getHastags),d.removeEventListener("input",window.validation.getComment),y.removeEventListener("click",L),g.removeEventListener("click",h),s.removeEventListener("submit",window.submitHandler)};window.closeEditForm=C;const $=e=>{document.activeElement!==a&&document.activeElement!==d&&window.util.isEscEvent(e,window.closeEditForm)}})(),(()=>{const e=document.querySelector("main"),t=e.querySelector(".img-upload__form"),r=t=>{window.closeEditForm();const r=document.querySelector("#"+t).content.cloneNode(!0),n=r.querySelector(`.${t}__button`);e.insertBefore(r,e.children[0]);const o=e.querySelector("."+t),s=()=>{o.remove(),document.removeEventListener("keydown",c),n.removeEventListener("click",l),e.removeEventListener("click",i)},c=e=>{window.util.isEscEvent(e,s)},l=()=>{s()},i=e=>{e.target===o&&s()};n.addEventListener("click",l),document.addEventListener("keydown",c),e.addEventListener("click",i)},n=()=>{r("success")},o=()=>{r("error")};window.submitHandler=e=>{window.backend.save(new FormData(t),n,o),e.preventDefault()}})()})();
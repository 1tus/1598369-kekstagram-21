(()=>{"use strict";window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},debounce:e=>{let t=null;return(...n)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...n)}),500)}}},(()=>{const e="https://21.javascript.pages.academy/kekstagram",t=(e,t)=>{const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(()=>{switch(n.status){case 200:e(n.response);break;case 400:t("Неверный запрос");break;case 401:t("Пользователь не авторизован");break;case 404:t("Ничего не найдено");break;default:t(`Статус ответа: ${n.status} ${n.statusText}`)}})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=1e4,n};window.backend={load:(n,r)=>{const o=t(n,r);o.open("GET",e+"/data"),o.send()},save:(n,r,o)=>{const l=t(r,o);l.open("POST",e),l.send(n)}}})(),window.filter={getRandomPictureObjects:e=>{let t=[],n=e.slice();for(let e=0;e<10;e++){let e=(0,r=n.length-1,Math.round(Math.random()*(r-0))+0);t.push(n[e]),n.splice(e,1)}var r;return t},sortByCommentsPictureObjects:e=>e.slice().sort(((e,t)=>t.comments.length-e.comments.length))},(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content,n=document.querySelector(".img-filters"),r=n.querySelector(".img-filters__form"),o=r.querySelectorAll(".img-filters__button"),l=r.querySelector("#filter-default"),i=r.querySelector("#filter-random"),s=r.querySelector("#filter-discussed"),c=e=>{const n=t.cloneNode(!0);return n.querySelector(".picture__img").src=e.url,n.querySelector(".picture__likes").textContent=e.likes,n.querySelector(".picture__comments").textContent=e.comments.length,n},a=t=>{(t=>{const n=e.querySelectorAll(".picture");for(let t=0;t<n.length;t++)e.removeChild(n[t]);const r=document.createDocumentFragment();for(let e=0;e<t.length;e++)r.appendChild(c(t[e]));e.appendChild(r)})(t);const n=e.querySelectorAll(".picture");for(let e=0;e<n.length;e++)window.getFullPicture(n[e],t[e])},d=window.util.debounce((e=>{let t;switch(e.target){case l:t=m;break;case i:t=window.filter.getRandomPictureObjects(m);break;case s:t=window.filter.sortByCommentsPictureObjects(m)}a(t)})),u=e=>{d(e),(e=>{for(let e of o)e.classList.remove("img-filters__button--active");e.classList.add("img-filters__button--active")})(e.target)};let m=[];window.backend.load((e=>{m=e,n.classList.remove("img-filters--inactive"),a(m),r.addEventListener("click",u)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red; position: absolute; left: 0; right: 0; font-size: 30px;",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}))})(),(()=>{const e=document.querySelector("body"),t=e.querySelector(".big-picture"),n=t.querySelector(".big-picture__cancel"),r=t.querySelector(".big-picture__img > img"),o=t.querySelector(".social__comments"),l=t.querySelector(".likes-count"),i=t.querySelector(".social__caption"),s=t.querySelector(".social__comment-count"),c=s.querySelector(".comments-count"),a=o.children,d=o.querySelector(".social__comment"),u=t.querySelector(".comments-loader"),m=e=>{const t=d.cloneNode(!0);return t.querySelector("img").src=e.avatar,t.querySelector("img").alt=e.name,t.querySelector(".social__text").textContent=e.message,t};window.getFullPicture=(d,v)=>{d.addEventListener("click",(()=>{(d=>{(()=>{for(let e=a.length-1;e>=0;e--)a[e].remove()})(),t.classList.remove("hidden"),e.classList.add("modal-open"),n.addEventListener("click",g),document.addEventListener("keydown",y),r.src=d.url,l.textContent=d.likes,c.textContent=d.comments.length,i.textContent=d.description;const v=document.createDocumentFragment();for(let e=0;e<d.comments.length;e++)v.appendChild(m(d.comments[e]));o.appendChild(v),(e=>{let t=5;if(a.length>t)for(let n=t;n<a.length;n++)a[n].classList.add("visually-hidden"),u.classList.remove("hidden"),s.textContent=`${t} из ${e.comments.length} комментариев`;else s.textContent=`${e.comments.length} из ${e.comments.length} комментариев`,u.classList.add("hidden");u.addEventListener("click",(()=>{if(t+5>=a.length&&(t=a.length-5,u.classList.add("hidden")),s.textContent=`${t+5} из ${e.comments.length} комментариев`,a.length>5){for(let e=t;e<t+5;e++)a[e].classList.remove("visually-hidden");t+=5}}))})(d)})(v)}))};const v=()=>{t.classList.add("hidden"),e.classList.remove("modal-open"),n.removeEventListener("click",g),document.removeEventListener("keydown",y)},y=e=>{window.util.isEscEvent(e,v)},g=()=>{v()}})(),(()=>{const e=document.querySelector(".text__hashtags"),t=document.querySelector(".text__description"),n="border: 4px solid red;",r="border: none;";window.validation={getHastagsValidation:()=>{const t=e.value.split(" ");t.length>5&&""!==t[0]?(e.setCustomValidity("Максимально допустимо 5 хэштегов"),e.style=n):t.every((e=>/^#[А-Яа-яЁёA-Za-z\d]{1,19}$/.test(e)))||""===t[0]?(()=>{let e,n,r=t.slice();for(;r.length;)e=r.shift(),r.indexOf(e)>=0&&(n=!0);return n})()&&""!==t[0]?(e.setCustomValidity("Недопустимы повторы хэштегов"),e.style=n):(e.setCustomValidity(""),e.style=r):(e.setCustomValidity("Недопустимый формат хэштега"),e.style=n),e.reportValidity()},getCommentValidation:()=>{const e=t.value.length;e>140?(t.setCustomValidity(`Удалите лишние ${e-140} симв.`),t.style=n):(t.setCustomValidity(""),t.style=r),t.reportValidity()}}})(),(()=>{const e=document.querySelector(".img-upload__effect-level"),t=e.querySelector(".effect-level__depth"),n=e.querySelector(".effect-level__pin"),r=e.querySelector(".effect-level__value");n.addEventListener("mousedown",(o=>{const l=e.querySelector(".effect-level__line").offsetWidth;let i=o.clientX;const s=e=>{const o=i-e.clientX;i=e.clientX;let s=n.offsetLeft-o;s<0?s=0:s>l&&(s=l),n.style.left=s+"px",t.style.width=s+"px",r.value=Math.round(100*s/l)},c=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",c)}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t={none:{min:0,max:0,getFilterStyle:()=>""},chrome:{min:0,max:1,getFilterStyle:e=>`grayscale(${e})`},sepia:{min:0,max:1,getFilterStyle:e=>`sepia(${e})`},marvin:{min:0,max:100,getFilterStyle:e=>`invert(${e}%)`},phobos:{min:0,max:3,getFilterStyle:e=>`blur(${e}px)`},heat:{min:1,max:3,getFilterStyle:e=>`brightness(${e})`}},n={min:25,max:100,step:25,current:100,getZoomStyle:e=>`transform: scale(${e/100})`},r=document.querySelector(".img-upload__start"),o=r.querySelector(".img-upload__input"),l=document.querySelector(".img-upload__form"),i=l.querySelector(".img-upload__overlay"),s=i.querySelector(".img-upload__preview > img"),c=i.querySelector(".img-upload__cancel"),a=i.querySelector(".text__hashtags"),d=i.querySelector(".text__description"),u=i.querySelector(".img-upload__effects"),m=u.querySelectorAll(".effects__preview"),v=u.querySelector("#effect-none"),y=i.querySelector(".scale__control--smaller"),g=i.querySelector(".scale__control--bigger"),p=i.querySelector(".scale__control--value"),_=document.querySelector(".img-upload__effect-level"),f=_.querySelector(".effect-level__pin"),w=_.querySelector(".effect-level__value"),S=_.querySelector(".effect-level__depth"),h=e=>{p.value=e+"%",s.style=n.getZoomStyle(e),e===n.max&&(g.disabled=!0),e===n.min&&(y.disabled=!0)},L=()=>{n.current=n.current-n.step,h(n.current),n.current<n.max&&(g.disabled=!1)},q=()=>{n.current=n.current+n.step,h(n.current),n.current>n.min&&(y.disabled=!1)};let E,b;const k=e=>{var n;return n=e.target.value,E&&s.classList.remove(E),s.classList.add("effects__preview--"+n),E="effects__preview--"+n,b=e.target.value,f.style.left="100%",S.style.width="100%",s.classList.contains("effects__preview--none")?(_.style.display="none",w.value=""):(_.style.display="block",w.value="100"),s.style.filter=t[b].getFilterStyle(t[b].max),f.addEventListener("mouseup",x),b},x=()=>{(e=>{const n=((e,n)=>{const r=t[e];return r.min+(r.max-r.min)/100*n})(e,w.value);s.style.filter=t[e].getFilterStyle(n)})(b)};r.addEventListener("change",(()=>{i.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),c.addEventListener("click",C),document.addEventListener("keydown",$),u.addEventListener("input",k),a.addEventListener("input",window.validation.getHastagsValidation),d.addEventListener("input",window.validation.getCommentValidation),(t=>{const n=t.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{s.src=e.result,Array.from(m).forEach((t=>{t.style=`background-image: url(${e.result})`}))})),e.readAsDataURL(t)}})(o.files[0]),h(n.current),_.style.display="none",y.addEventListener("click",L),g.addEventListener("click",q),l.addEventListener("submit",window.submitHandler)}));const C=()=>{window.closeEditForm()};window.closeEditForm=()=>{i.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),o.value="",s.className="",s.style.filter="",a.value="",d.value="",v.checked="true",w.value="",n.current=n.max,y.disabled=!1,c.removeEventListener("click",C),document.removeEventListener("keydown",$),u.removeEventListener("input",k),f.removeEventListener("mouseup",x),a.removeEventListener("input",window.validation.getHastagsValidation),d.removeEventListener("input",window.validation.getCommentValidation),y.removeEventListener("click",L),g.removeEventListener("click",q),l.removeEventListener("submit",window.submitHandler)};const $=e=>{document.activeElement!==a&&document.activeElement!==d&&window.util.isEscEvent(e,window.closeEditForm)}})(),(()=>{const e=document.querySelector("main"),t=e.querySelector(".img-upload__form"),n=t=>{window.closeEditForm();const n=document.querySelector("#"+t).content.cloneNode(!0),r=n.querySelector(`.${t}__button`);e.insertBefore(n,e.children[0]);const o=e.querySelector("."+t),l=()=>{o.remove(),document.removeEventListener("keydown",i),r.removeEventListener("click",s),e.removeEventListener("click",c)},i=e=>{window.util.isEscEvent(e,l)},s=()=>{l()},c=e=>{e.target===o&&l()};r.addEventListener("click",s),document.addEventListener("keydown",i),e.addEventListener("click",c)},r=()=>{n("success")},o=()=>{n("error")};window.submitHandler=e=>{window.backend.save(new FormData(t),r,o),e.preventDefault()}})()})();
(()=>{"use strict";window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},debounce:e=>{let t=null;return(...n)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...n)}),500)}}},(()=>{const e="https://21.javascript.pages.academy/kekstagram",t=(e,t)=>{const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(()=>{switch(n.status){case 200:e(n.response);break;case 400:t("Неверный запрос");break;case 401:t("Пользователь не авторизован");break;case 404:t("Ничего не найдено");break;default:t(`Статус ответа: ${n.status} ${n.statusText}`)}})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=1e4,n};window.backend={load:(n,r)=>{const o=t(n,r);o.open("GET",e+"/data"),o.send()},save:(n,r,o)=>{const l=t(r,o);l.open("POST",e),l.send(n)}}})(),window.filter={getRandomPictureObjects:e=>{let t=[],n=e.slice();for(let e=0;e<10;e++){let e=(0,r=n.length-1,Math.round(Math.random()*(r-0))+0);t.push(n[e]),n.splice(e,1)}var r;return t},sortByCommentsPictureObjects:e=>e.slice().sort(((e,t)=>t.comments.length-e.comments.length))},(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content,n=document.querySelector(".img-filters"),r=n.querySelector(".img-filters__form"),o=r.querySelectorAll(".img-filters__button"),l=r.querySelector("#filter-default"),i=r.querySelector("#filter-random"),c=r.querySelector("#filter-discussed"),s=e=>{const n=t.cloneNode(!0);return n.querySelector(".picture__img").src=e.url,n.querySelector(".picture__likes").textContent=e.likes,n.querySelector(".picture__comments").textContent=e.comments.length,n},a=t=>{(t=>{const n=e.querySelectorAll(".picture");for(let t=0;t<n.length;t++)e.removeChild(n[t]);const r=document.createDocumentFragment();for(let e=0;e<t.length;e++)r.appendChild(s(t[e]));e.appendChild(r)})(t);const n=e.querySelectorAll(".picture");for(let e=0;e<n.length;e++)window.getFullPicture(n[e],t[e])},d=window.util.debounce((e=>{let t;switch(e.target){case l:t=m;break;case i:t=window.filter.getRandomPictureObjects(m);break;case c:t=window.filter.sortByCommentsPictureObjects(m)}a(t)})),u=e=>{d(e),(e=>{for(let e of o)e.classList.remove("img-filters__button--active");e.classList.add("img-filters__button--active")})(e.target)};let m=[];window.backend.load((e=>{m=e,n.classList.remove("img-filters--inactive"),a(m),r.addEventListener("click",u)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red; position: absolute; left: 0; right: 0; font-size: 30px;",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}))})(),(()=>{const e=document.querySelector("body"),t=e.querySelector(".big-picture"),n=t.querySelector(".big-picture__cancel"),r=t.querySelector(".big-picture__img > img"),o=t.querySelector(".social__comments"),l=t.querySelector(".likes-count"),i=t.querySelector(".social__caption"),c=t.querySelector(".social__comment-count"),s=c.querySelector(".comments-count"),a=o.children,d=o.querySelector(".social__comment"),u=t.querySelector(".comments-loader"),m=e=>{const t=d.cloneNode(!0);return t.querySelector("img").src=e.avatar,t.querySelector("img").alt=e.name,t.querySelector(".social__text").textContent=e.message,t},v=(d,v)=>{(()=>{for(let e=a.length-1;e>=0;e--)a[e].remove()})(),t.classList.remove("hidden"),e.classList.add("modal-open"),n.addEventListener("click",p),document.addEventListener("keydown",g),r.src=v.url,l.textContent=v.likes,s.textContent=v.comments.length,i.textContent=v.description;const y=document.createDocumentFragment();for(let e=0;e<v.comments.length;e++)y.appendChild(m(v.comments[e]));o.appendChild(y),(e=>{let t=5;if(a.length>t)for(let n=t;n<a.length;n++)a[n].classList.add("visually-hidden"),u.classList.remove("hidden"),c.textContent=`${t} из ${e.comments.length} комментариев`;else c.textContent=`${e.comments.length} из ${e.comments.length} комментариев`,u.classList.add("hidden");u.addEventListener("click",(()=>{if(t+5>=a.length&&(t=a.length-5,u.classList.add("hidden")),c.textContent=`${t+5} из ${e.comments.length} комментариев`,a.length>5){for(let e=t;e<t+5;e++)a[e].classList.remove("visually-hidden");t+=5}}))})(v)};window.getFullPicture=(e,t)=>{e.addEventListener("click",(()=>{v(0,t)})),e.addEventListener("keydown",(e=>{"Enter"===e.key&&v(0,t)}))};const y=()=>{t.classList.add("hidden"),e.classList.remove("modal-open"),n.removeEventListener("click",p),document.removeEventListener("keydown",g)},g=e=>{window.util.isEscEvent(e,y)},p=()=>{y()}})(),(()=>{const e=document.querySelector(".text__hashtags"),t=document.querySelector(".text__description");window.validation={getHastagsValidation:()=>{const t=e.value.split(" ");t.length>5&&""!==t[0]?e.setCustomValidity("Максимально допустимо 5 хэштегов"):t.every((e=>/^#[А-Яа-яЁёA-Za-z\d]{1,19}$/.test(e)))||""===t[0]?(()=>{let e,n,r=t.slice(0);for(;r.length;)e=r.shift(),r.indexOf(e)>=0&&(n=!0);return n})()&&""!==t[0]?e.setCustomValidity("Недопустимы повторы хэштегов"):e.setCustomValidity(""):e.setCustomValidity("Недопустимый формат хэштега"),e.reportValidity()},getCommentValidation:()=>{const e=t.value.length;e>140?t.setCustomValidity(`Удалите лишние ${e-140} симв.`):t.setCustomValidity(""),t.reportValidity()}}})(),(()=>{const e=document.querySelector(".img-upload__effect-level"),t=e.querySelector(".effect-level__depth"),n=e.querySelector(".effect-level__pin"),r=e.querySelector(".effect-level__value");n.addEventListener("mousedown",(o=>{const l=e.querySelector(".effect-level__line").offsetWidth;let i=o.clientX;const c=e=>{const o=i-e.clientX;i=e.clientX;let c=n.offsetLeft-o;c<0?c=0:c>l&&(c=l),n.style.left=c+"px",t.style.width=c+"px",r.value=Math.round(100*c/l)},s=()=>{document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",s)}))})(),(()=>{const e={none:{min:0,max:0,getFilterStyle:()=>""},chrome:{min:0,max:1,getFilterStyle:e=>`grayscale(${e})`},sepia:{min:0,max:1,getFilterStyle:e=>`sepia(${e})`},marvin:{min:0,max:100,getFilterStyle:e=>`invert(${e}%)`},phobos:{min:0,max:3,getFilterStyle:e=>`blur(${e}px)`},heat:{min:1,max:3,getFilterStyle:e=>`brightness(${e})`}},t={min:25,max:100,step:25,current:100,getZoomStyle:e=>`transform: scale(${e/100})`},n=document.querySelector(".img-upload__start"),r=n.querySelector(".img-upload__input"),o=document.querySelector(".img-upload__form"),l=o.querySelector(".img-upload__overlay"),i=l.querySelector(".img-upload__preview > img"),c=l.querySelector(".img-upload__cancel"),s=l.querySelector(".text__hashtags"),a=l.querySelector(".text__description"),d=l.querySelector(".img-upload__effects"),u=d.querySelector("#effect-none"),m=l.querySelector(".scale__control--smaller"),v=l.querySelector(".scale__control--bigger"),y=l.querySelector(".scale__control--value"),g=document.querySelector(".img-upload__effect-level"),p=g.querySelector(".effect-level__pin"),_=g.querySelector(".effect-level__value"),f=g.querySelector(".effect-level__depth"),S=e=>{y.value=e+"%",i.style=t.getZoomStyle(e),e===t.max&&(v.disabled=!0),e===t.min&&(m.disabled=!0)},w=()=>{t.current=t.current-t.step,S(t.current),t.current<t.max&&(v.disabled=!1)},L=()=>{t.current=t.current+t.step,S(t.current),t.current>t.min&&(m.disabled=!1)};let h,E;const q=t=>{var n;return n=t.target.value,h&&i.classList.remove(h),i.classList.add("effects__preview--"+n),h="effects__preview--"+n,E=t.target.value,p.style.left="100%",f.style.width="100%",i.classList.contains("effects__preview--none")?(g.style.display="none",_.value=""):(g.style.display="block",_.value="100"),i.style.filter=e[E].getFilterStyle(e[E].max),p.addEventListener("mouseup",b),E},b=()=>{(t=>{const n=((t,n)=>{const r=e[t];return r.min+(r.max-r.min)/100*n})(t,_.value);i.style.filter=e[t].getFilterStyle(n)})(E)};n.addEventListener("change",(()=>{l.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),c.addEventListener("click",k),document.addEventListener("keydown",x),d.addEventListener("input",q),s.addEventListener("input",window.validation.getHastagsValidation),a.addEventListener("input",window.validation.getCommentValidation),i.src=URL.createObjectURL(r.files[0]),S(t.current),g.style.display="none",m.addEventListener("click",w),v.addEventListener("click",L),o.addEventListener("submit",window.submitHandler)}));const k=()=>{window.closeEditForm()};window.closeEditForm=()=>{l.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),r.value="",i.className="",i.style.filter="",s.value="",a.value="",u.checked="true",_.value="",t.current=t.max,m.disabled=!1,c.removeEventListener("click",k),document.removeEventListener("keydown",x),d.removeEventListener("input",q),p.removeEventListener("mouseup",b),s.removeEventListener("input",window.validation.getHastagsValidation),a.removeEventListener("input",window.validation.getCommentValidation),m.removeEventListener("click",w),v.removeEventListener("click",L),o.removeEventListener("submit",window.submitHandler)};const x=e=>{document.activeElement!==s&&document.activeElement!==a&&window.util.isEscEvent(e,window.closeEditForm)}})(),(()=>{const e=document.querySelector("main"),t=e.querySelector(".img-upload__form"),n=t=>{window.closeEditForm();const n=document.querySelector("#"+t).content.cloneNode(!0),r=n.querySelector(`.${t}__button`);e.insertBefore(n,e.children[0]);const o=e.querySelector("."+t),l=()=>{o.remove(),document.removeEventListener("keydown",i),r.removeEventListener("click",c),e.removeEventListener("click",s)},i=e=>{window.util.isEscEvent(e,l)},c=()=>{l()},s=e=>{e.target===o&&l()};r.addEventListener("click",c),document.addEventListener("keydown",i),e.addEventListener("click",s)},r=()=>{n("success")},o=()=>{n("error")};window.submitHandler=e=>{window.backend.save(new FormData(t),r,o),e.preventDefault()}})()})();
